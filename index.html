<!DOCTYPE html>
<html>
  <head>
    <style>
      :root {
        --primary: #4d7cfe;
        --secondary: #ff6b45;
        --text-dark: #333333;
        --text-light: #666666;
        --bg-light: #f5f7fa;
        --white: #ffffff;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --border-radius: 8px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
      }

      body {
        background-color: var(--bg-light);
        margin: 0;
        padding: 0;
      }

      main {
        display: flex;
        height: 100vh;
        justify-content: center;
        margin: 0;
        padding: 0;
      }

      .hidden {
        display: none !important;
      }

      #titlebar {
        height: 60px;
        width: 100%;
        background-color: var(--white);
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        padding: 0 20px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
      }

      .app-logo-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .main-logo {
        font-weight: 700;
        font-size: 2.8rem;  /* 2x the original size */
        color: #4d7cfe;     /* Blue color from the variables */
      }
      
      .main-logo span {
        color: #ff6b45;     /* Secondary color for "Mitra" */
      }
      
      .sub-logo {
        font-weight: 600;
        font-size: 1rem;    /* Smaller than the main logo */
        color: #666666;     /* Text light color from variables */
      }
      
      .sub-logo span {
        color: #ff6b45;     /* Secondary color for "Connect" */
      }

      .search-container {
        margin-left: auto;
        margin-right: 20px;
        position: relative;
      }

      .search-container input {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        width: 250px;
        font-size: 0.9rem;
        outline: none;
      }

      .search-icon {
        position: absolute;
        right: 12px;
        top: 8px;
        color: #aaa;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        text-decoration: none;
        color: var(--text-dark);
        font-size: 0.9rem;
      }

      .theme-toggle {
        width: 32px;
        height: 32px;
        background: var(--bg-light);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 20px;
        cursor: pointer;
      }

      #app-container {
        display: flex;
        width: 100%;
        margin-top: 60px;
        height: calc(100vh - 60px);
      }

      #sidebar {
        width: 220px;
        background-color: var(--white);
        box-shadow: var(--shadow);
        padding: 20px 0;
      }

      .nav-item {
        padding: 12px 24px;
        color: var(--text-light);
        display: block;
        text-decoration: none;
        transition: all 0.2s ease;
      }

      .nav-item.active, .nav-item:hover {
        background-color: rgba(77, 124, 254, 0.1);
        color: var(--primary);
        border-left: 3px solid var(--primary);
      }

      #content {
        flex: 1;
        padding: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .header {
        margin-bottom: 24px;
      }

      .content-title {
        font-size: 1.5rem;
        color: var(--text-dark);
        margin-bottom: 24px;
      }

      #setup {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--white);
        border-radius: var(--border-radius);
        padding: 40px;
        box-shadow: var(--shadow);
        width: 400px;
        margin: auto;
      }

      #setup h2 {
        margin-bottom: 24px;
        color: var(--text-dark);
      }

      button, input {
        border: 1px solid #e0e0e0;
        background: var(--white);
        color: var(--text-dark);
        padding: 10px 16px;
        font-size: 0.9rem;
        border-radius: 4px;
        outline: none;
        transition: all 0.2s ease;
      }

      button {
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        width: 100%;
        font-weight: 500;
      }

      button:hover {
        background: #3a6be0;
      }

      button#join-chat-room {
        background: var(--secondary);
      }

      button#join-chat-room:hover {
        background: #e55b35;
      }

      #or {
        margin: 24px auto;
        color: var(--text-light);
        position: relative;
      }

      #or::before, #or::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40px;
        height: 1px;
        background-color: #e0e0e0;
      }

      #or::before {
        left: -50px;
      }

      #or::after {
        right: -50px;
      }

      #join-form {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #join-chat-room-topic {
        width: 100%;
      }

      #loading {
        align-self: center;
        color: var(--primary);
        font-size: 1.2rem;
      }

      #chat {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      #header {
        padding: 16px 24px;
        border-bottom: 1px solid #e0e0e0;
        background-color: var(--white);
      }

      #details {
        display: flex;
        justify-content: space-between;
        color: var(--text-dark);
      }

      #chat-room-topic {
        font-weight: 600;
        color: var(--primary);
        word-break: break-all;
        font-family: monospace;
        font-size: 0.85rem;
      }

      #peers-count {
        background: rgba(255, 107, 69, 0.1);
        color: var(--secondary);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background-color: var(--bg-light);
      }

      .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        word-break: break-word;
      }

      .message.received {
        align-self: flex-start;
        background-color: var(--white);
        border-bottom-left-radius: 0;
      }

      .message.sent {
        align-self: flex-end;
        background-color: var(--primary);
        color: white;
        border-bottom-right-radius: 0;
      }

      .message-info {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        display: flex;
        justify-content: space-between;
      }

      #message-form {
        display: flex;
        padding: 16px 24px;
        gap: 12px;
        border-top: 1px solid #e0e0e0;
        background-color: var(--white);
      }

      #message {
        flex: 1;
        border-radius: 20px;
      }

      #message-form button {
        border-radius: 20px;
        padding: 10px 24px;
        width: auto;
      }

      .topic-display {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .copy-button {
        background: rgba(77, 124, 254, 0.1);
        color: var(--primary);
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: pointer;
        padding: 0;
      }

      .message-raw {
        font-family: monospace;
        font-size: 0.9rem;
      }
    </style>
    <script type='module' src='./app.js'></script>
  </head>
  <body>
    <div id="titlebar">
      <div class="app-logo-container">
        <div class="main-logo">Prep<span>Mitra</span></div>
        <div class="sub-logo">Mentor<span>Connect</span></div>
      </div>
      <div class="search-container">
        <input type="text" placeholder="Search...">
        <span class="search-icon">üîç</span>
      </div>
      <div class="nav-links">
        <a href="#">Features</a>
        <a href="#">Pricing</a>
      </div>
      <div class="theme-toggle">üåô</div>
    </div>
    <div id="app-container">
      <div id="sidebar">
        <a href="#" class="nav-item">Dashboard</a>
        <a href="#" class="nav-item active">Mentors Chat</a>
        <a href="#" class="nav-item">My Sessions</a>
        <a href="#" class="nav-item">Resources</a>
        <a href="#" class="nav-item">Progress</a>
        <a href="#" class="nav-item">User Profile</a>
        <a href="#" class="nav-item">About Us</a>
      </div>
      <div id="content">
        <div class="header">
          <h1 class="content-title">Connect with Mentors</h1>
        </div>
        <div id="setup">
          <h2>Start a conversation</h2>
          <div>
            <button id="create-chat-room">Create New Session</button>
          </div>
          <div id="or">or</div>
          <form id="join-form">
            <input required id="join-chat-room-topic" type="text" placeholder="Enter session ID (hex)" />
            <button type="submit" id="join-chat-room">Join Existing Session</button>
          </form>
        </div>
        <div id="loading" class="hidden">Connecting to P2P network...</div>
        <div id="chat" class="hidden">
          <div id="header">
            <div id="details">
              <div class="topic-display">
                Session ID: <span id="chat-room-topic"></span>
                <button class="copy-button" id="copy-topic" title="Copy Session ID">üìã</button>
              </div>
              <div>
                Participants: <span id="peers-count">0</span>
              </div>
            </div>
          </div>
          <div id="messages">
            <!-- Messages will be added here dynamically -->
          </div>
          <form id="message-form">
            <input id="message" type="text" placeholder="Type your message here..." />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>
    </div>
    <script type="module">
      // Import modules
      import Hyperswarm from 'hyperswarm'
      import crypto from 'hypercore-crypto'
      import b4a from 'b4a'
      const { teardown, updates } = Pear

      const swarm = new Hyperswarm()

      // Clean up on exit
      teardown(() => swarm.destroy())

      // Enable auto-reloading
      updates(() => Pear.reload())

      // Track connections and update UI
      swarm.on('connection', (peer) => {
        // Get peer name from public key
        const name = b4a.toString(peer.remotePublicKey, 'hex').slice(0, 6)
        
        // Listen for messages
        peer.on('data', message => {
          const messageText = b4a.toString(message)
          addMessageToUI(name, messageText, 'received')
        })
        
        // Handle connection errors
        peer.on('error', e => console.log(`Connection error: ${e}`))
        
        // Update participant count
        updatePeersCount()
        
        // Welcome message
        const welcomeMsg = `A new participant (${name}) has joined the session`
        addSystemMessage(welcomeMsg)
      })

      // Update participant count when swarm changes
      swarm.on('update', () => {
        updatePeersCount()
      })

      // Set up event listeners
      document.querySelector('#create-chat-room').addEventListener('click', createChatRoom)
      document.querySelector('#join-form').addEventListener('submit', joinChatRoom)
      document.querySelector('#message-form').addEventListener('submit', sendMessage)
      document.querySelector('#copy-topic').addEventListener('click', copySessionId)

      // Create a new chat room with random topic
      async function createChatRoom() {
        // Generate random 32-byte key
        const topicBuffer = crypto.randomBytes(32)
        joinSwarm(topicBuffer)
      }

      // Join an existing chat room
      async function joinChatRoom(e) {
        e.preventDefault()
        const topicStr = document.querySelector('#join-chat-room-topic').value.trim()
        
        try {
          // Convert hex string to buffer
          const topicBuffer = b4a.from(topicStr, 'hex')
          joinSwarm(topicBuffer)
        } catch (error) {
          alert('Invalid session ID format. Please enter a valid hexadecimal ID.')
          console.error('Error joining room:', error)
        }
      }

      // Join the swarm with the given topic
      async function joinSwarm(topicBuffer) {
        document.querySelector('#setup').classList.add('hidden')
        document.querySelector('#loading').classList.remove('hidden')

        try {
          // Join the swarm with the topic - both client and server mode
          const discovery = swarm.join(topicBuffer, { client: true, server: true })
          await discovery.flushed()

          // Convert topic buffer to hex string for display
          const topic = b4a.toString(topicBuffer, 'hex')
          document.querySelector('#chat-room-topic').innerText = topic
          
          // Show chat UI
          document.querySelector('#loading').classList.add('hidden')
          document.querySelector('#chat').classList.remove('hidden')
          
          // Add welcome message
          addSystemMessage('Session created. Waiting for participants to join...')
          addSystemMessage('Share your Session ID for others to join this chat.')
          
          // Focus message input
          document.querySelector('#message').focus()
          
        } catch (error) {
          alert('Failed to join the session. Please try again.')
          console.error('Error joining swarm:', error)
          document.querySelector('#loading').classList.add('hidden')
          document.querySelector('#setup').classList.remove('hidden')
        }
      }

      // Send a message to all peers
      function sendMessage(e) {
        e.preventDefault()
        const messageInput = document.querySelector('#message')
        const messageText = messageInput.value.trim()
        
        if (messageText) {
          // Add message to own UI
          addMessageToUI('You', messageText, 'sent')
          
          // Clear input
          messageInput.value = ''
          
          // Send to all connected peers
          const peers = [...swarm.connections]
          for (const peer of peers) {
            peer.write(messageText)
          }
        }
        
        // Focus input for next message
        messageInput.focus()
      }

      // Add a message to the UI
      function addMessageToUI(sender, message, type) {
        const messagesContainer = document.querySelector('#messages')
        const messageElement = document.createElement('div')
        messageElement.className = `message ${type}`
        
        const now = new Date()
        const time = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes()
        
        messageElement.innerHTML = `
          <span class="message-raw">${escapeHTML(message)}</span>
          <div class="message-info">
            <span>${escapeHTML(sender)}</span>
            <span>${time}</span>
          </div>
        `
        
        messagesContainer.appendChild(messageElement)
        scrollToBottom()
      }

      // Add a system message
      function addSystemMessage(message) {
        const messagesContainer = document.querySelector('#messages')
        const messageElement = document.createElement('div')
        messageElement.style.textAlign = 'center'
        messageElement.style.color = '#666'
        messageElement.style.fontSize = '0.8rem'
        messageElement.style.margin = '8px 0'
        messageElement.textContent = message
        
        messagesContainer.appendChild(messageElement)
        scrollToBottom()
      }

      // Update the peers count in the UI
      function updatePeersCount() {
        document.querySelector('#peers-count').textContent = swarm.connections.size
      }

      // Copy session ID to clipboard
      function copySessionId() {
        const sessionId = document.querySelector('#chat-room-topic').textContent
        navigator.clipboard.writeText(sessionId)
          .then(() => {
            alert('Session ID copied to clipboard!')
          })
          .catch(err => {
            console.error('Failed to copy: ', err)
          })
      }

      // Helper: Scroll chat to bottom
      function scrollToBottom() {
        const messagesContainer = document.querySelector('#messages')
        messagesContainer.scrollTop = messagesContainer.scrollHeight
      }

      // Helper: Escape HTML to prevent XSS
      function escapeHTML(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }
    </script>
  </body>
</html>